# 🧪 Run Test Suite
# Triggers only when a version tag is pushed (e.g., v1.2.3), or manually from the UI.
# Sets up Python, runs tests via CI orchestrator, uploads reports, and pushes files to main.

name: 🧪 Run Test Suite

on:
  # 🚀 Manual trigger from GitHub UI
  workflow_dispatch:

  # 🔁 Trigger only on version tags (e.g., v1.0.0)
  push:
    tags:
      - 'v*'  # Matches semantic version tags like v1.2.3

    # Optional: also trigger when version file changes on main
    branches:
      - main
    paths:
      - '**/version.txt'  # Adjust to your versioning file if needed

permissions:
  contents: write  # 🛡️ Required for pushing files back to the repo

jobs:
  test-and-report:
    runs-on: ubuntu-latest  # 🐧 Latest stable Ubuntu

    steps:
      ## \brief Clone the full repository history
      ## \details Required for accurate commit diffing and tagging
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      ## \brief Set up Python environment
      ## \details Uses Python 3.11 for compatibility with orchestrator and test scripts
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      ## \brief Install dependencies from requirements.txt
      ## \details Skips gracefully if no requirements file is present
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "No requirements.txt found"

      ## \brief Clean old logs and reports before test run
      ## \details Ensures fresh output for each CI cycle
      - name: Clean old logs and reports
        run: |
          rm -f build/logs/*.log || true
          rm -f reports/*.md reports/*.json || true

      ## \brief Run the CI orchestrator script
      ## \details Executes all discovered tests and generates reports
      - name: Run CI Orchestrator
        run: python3 -m utils.ci_orchestrator

      ## \brief Upload Markdown test report
      ## \details Useful for human-readable summaries
      - name: Upload Markdown Report
        uses: actions/upload-artifact@v4
        with:
          name: markdown-report
          path: reports/*.md

      ## \brief Upload JSON test report
      ## \details Used for machine-readable CI dashboards or parsing
      - name: Upload JSON Report
        uses: actions/upload-artifact@v4
        with:
          name: json-report
          path: reports/*.json

      ## \brief Upload debug logs from test run
      ## \details Helps diagnose failures or unexpected behavior
      - name: Upload Debug Logs
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs
          path: build/logs/*.log

      ## \brief Commit and push latest logs and reports to main
      ## \details Only commits if there are changes; avoids empty commits
      - name: Push Reports and Logs to Main
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add build/logs/*.log reports/*.md reports/*.json
          git diff --cached --quiet || git commit -m "🧪 CI: Push latest logs and reports"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
